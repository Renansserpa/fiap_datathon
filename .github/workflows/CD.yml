name: Primeiro Workflow

on:
  push:
    # Ser√° executado quando um git push ocorrer na branch main
    branches: [ "main" ]

jobs:

  increase_version:
    runs-on: ubuntu-latest
    outputs:
      # Vari√°vel para incremento de vers√£o
      NEW_VERSION: ${{ steps.tag_increase.outputs.NEW_VERSION }}

    steps:

      # Fetch do reposit√≥rio
      - name: Baixando reposit√≥rio
        uses: actions/checkout@v4
        with:
          # Flag para download de tags
          fetch-depth: 0
          fetch-tags: true

      # Script bash para incremento de vers√£o (resultado ser√° salvo na vari√°vel 'NEW_VERSION')
      - name: Incrementa vers√£o
        id: tag_increase
        run: |
          # Obt√©m a √∫ltima mensagem do commit
          last_commit=$(git log -1 --no-merges --pretty=%B)
          echo $last_commit
          # Se o √∫ltimo commit for relacionado a um patch (Ex: 0.0.1)
          if [[ $last_commit == patch* ]]; then
              NEW_VERSION=`git describe --tags --abbrev=0 | awk -F. '{OFS="."; $3+=1; print $0}'`
          # Se o √∫ltimo commit for relacionado a um minor (Ex: 0.1.0)
          elif [[ $last_commit == minor* ]]; then
              NEW_VERSION=`git describe --tags --abbrev=0 | awk -F. '{OFS="."; $2+=1; $3=0; print $0}'`
          # Se o √∫ltimo commit for relacionado a um major (Ex: 1.0.0)
          elif [[ $last_commit == major* ]]; then
              NEW_VERSION=`git describe --tags --abbrev=0 | awk -F. '{OFS="."; sub(/^v/, "", $1); $1+=1; $2=0; $3=0; print "v"$0}'`
          else
              echo "N√£o especifica versao, logo n√£o executa c√≥digo"
              exit 1
          fi

          if ![[ $NEW_VERSION == v* ]]; then
              echo "Precisa comecar com v a vers√£o"
              exit 1
          fi

          # Redirecionar a nova vers√£o armazenada em 'NEW_VERSION' para a vari√°vel de ambiente do GitHub 'GITHUB_OUTPUT'
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

  publish:
    # Jobs executam em paralelo, s√≥ faz sentido seguir para 'publish' quando 'increase_version' tiver executado
    # A palavra reservada 'needs' serve para travar a execu√ß√£o do 'publish' at√© que 'increase_version' termine
    needs: [increase_version]

    # Execu√ß√£o em uma m√°quina ubuntu
    runs-on: ubuntu-latest
    
    # Vari√°veis de ambiente
    environment:
      name: testpypi
      url: https://test.pypi.org/p/datathon-ml-communication

    # Permiss√µes necess√°rias
    permissions:
      contents: write
      id-token: write

    steps:
      # Cada Job √© executado em uma outra m√°quina, por isso √© necess√°rio novamente o fetch do reposit√≥rio
      - name: Baixando reposit√≥rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Adiciona Tag

        run: |
          # Configura√ß√£o de username
          git config user.name "$(git log -n 1 --pretty=format:%an)"
          # Configura√ß√£o de user e-mail
          git config user.email "$(git log -n 1 --pretty=format:%ae)"
          # Cria√ß√£o de nova tag
          git tag -a "${{ needs.increase_version.outputs.NEW_VERSION }}" -m "change version"
          git tag


      - name: Configurando Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: 'x64'

      - name: Instalando depend√™ncias de publica√ß√£o do pacote
        run: pip install -U build==1.2.1 twine==5.1.1


      - name: Cria o diret√≥rio da distribui√ß√£o
        run: python -m build

      - name: Publish distribution üì¶ to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

      - name: Update package tag
        run: |
          echo "${{ needs.increase_version.outputs.NEW_VERSION }}"
          git push origin "${{ needs.increase_version.outputs.NEW_VERSION }}"